<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="/css/weather-icons.min.css">
        <link rel="stylesheet" type="text/css" href="/css/site.css">
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>        
        <script src="/js/weatherIconXref.js"></script>
        <script src="/js/conditions.js"></script>
    </head>
    <body style="padding:10px;">
        <div class="container-fluid">
            <div class="row header">
                <div class="col-sm-offset-0 col-sm-12 col-md-offset-1 col-md-10">
                    <div class="panel panel-default">
                        <div class="panel-heading text-center jumbotron">
                            <h1 style="display:inline; vertical-align:middle;" class="heading">
                                <div class="row">
                                    <div id="iconsLeft" class="col-sm-4 col-md-3">
                                        <span class="glyphicon glyphicon-flash"></span>
                                        <span class="glyphicon glyphicon-cloud"></span>
                                    </div>
                                    <div id="title" class="col-sm-4 col-md-6">
                                        <span>Garden Shed Conditions</span>
                                    </div>
                                    <div id="iconsRight" class="col-sm-4 col-md-3">
                                        <span class="glyphicon glyphicon-cloud"></span>    
                                        <span class="glyphicon glyphicon-flash"></span>
                                    </div>
                                </div>
                            </h1>
                        </div>
                        <div class="panel-body content">
                            <div class="row">
                                <div class="col-sm-offset-1 col-sm-12 col-md-5">
                                    <div id="inside">
                                        <h1>Shed Conditions <button class="btn btn-default" id="btnRefreshShed"><span style="display:inline-block;" id="btnRefreshGlyph" class="glyphicon glyphicon-refresh"></span></button></h1>
                                        <div id="obsTimeDiv" style="font-size:14pt;">Observed on: <span id="observationTime"></span></div>
                                        <h2><i class="icon wi wi-thermometer"></i><span>&nbsp;Temperature:&nbsp;<span id="temp"></span></span></h2>
                                        <h2><i class="icon wi wi-humidity"></i><span>&nbsp;Humidity:&nbsp;<span id="humid"></span></span></h2>
                                    </div>
                                </div>
                                <div class="form-group col-sm-12 col-md-5">
                                    <div class="panel panel-info">
                                        <div class="panel-heading text-center">
                                            <h2>Add Notifications</h2>
                                        </div>
                                        <div class="panel-body">
                                            <form class="form-horizontal">
                                                 Currently Sending Alerts to:
                                                <ul id="liUsers">    
                                                    <!--<li>Chloe@ThatDogPlace.com</li>
                                                    <li>Memphis@KittyKorners.co.uk</li>
                                                    <li>Minch@jediu.edu</li>-->
                                                </ul>
                                                <div class="form-group">
                                                    <label for="txtLowTemp" class="col-sm-7 control-label">Warn if Temps go below: </label>
                                                    <div class="col-sm-5">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" autocomplete="false" min="-50" max="150" placeholder="-##" pattern="^-?[0-9]\d*?$" required="true" id="txtLowTemp" />
                                                            <div class="input-group-addon">&deg;F</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="txtHighTemp" class="col-sm-7 control-label">Warn if Temps go above: </label>
                                                    <div class="col-sm-5">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" autocomplete="false" min="-50" max="150" placeholder="###" pattern="^-?[0-9]\d*?$" required="true" id="txtHighTemp" />
                                                            <div class="input-group-addon">&deg;F</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>                                
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-offset-1 col-sm-10">
                                    <div class="panel panel-info hidden" id="activePanel">
                                        <div class="panel-heading">
                                            Active Notifications
                                        </div>
                                        <div class="panel-body" id="activePanelBody">
                                        </div>
                                    </div>                                
                                </div>
                            </div>
                            <!--
                            <div class="row">
                                <div class="col-sm-offset-1 col-sm-10">
                                    <div class="panel panel-info hidden" id="inactivePanel">
                                        <div class="panel-heading">
                                            Inactive Notifications
                                        </div>
                                        <div class="panel-body" id="inactivePanelBody">                                     
                                        </div>
                                    </div>                                
                                </div>
                            </div>                            
                            -->
                            <div class="row">
                                <div class="col-sm-offset-1 col-sm-10">
                                    <button class="btn btn-default" id="showExtConditions">Show Outside Conditions</button>
                                    <div id="outside" class="hidden">
                                        <h1>Outside Conditions <button class="btn btn-default" id="btnRefreshExt"><span class="glyphicon glyphicon-refresh"></span></button></h1>
                                        <div style="font-size:14pt;">Observed on: <span id="extObservationTime"></span> from station <span id="extStationID"></span></div>
                                        <h2><i id="extCondIcon" class="icon wi "></i>&nbsp;Currently:&nbsp;<span id="extCondition"></span></h2>
                                        <h2><i class="icon wi wi-thermometer"></i>&nbsp;Temperature:&nbsp;<span id="extTemp"></span></h2>
                                        <h2><i class="icon wi wi-humidity"></i>&nbsp;Humidity:&nbsp;<span id="extHumid"></span></h2>
                                        <h2><i class="icon wi wi-cloudy-gusts"></i>&nbsp;Wind:&nbsp;<span id="extWind"></span></h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>    
                    <div id="wuLogo" class="text-right hidden"><strong>Outside Conditions Provided By:&nbsp;&nbsp;</strong><a href="https://www.wunderground.com/?apiref=cd49dbb7619f6522"><img src="/images/wundergroundLogo_4c_horz.png" style="width:140px; margin-top:-12px;" /></a></div>        
                </div>
            </div>
        </div>
    </body>
</html>



<script type="text/javascript">

jQuery.fn.rotate = function() {
    degrees = $(this).data("angle");
    $(this).css({'-webkit-transform' : 'rotate('+ degrees +'deg)',
                 '-moz-transform' : 'rotate('+ degrees +'deg)',
                 '-ms-transform' : 'rotate('+ degrees +'deg)',
                 'transform' : 'rotate('+ degrees +'deg)'});
    $(this).data("angle", degrees + 5);                 
};

$(function(){
    $('#btnRefreshGlyph').data("angle", 0);
    resizeHeader();
    getShedConditions();
    //Uncomment to show Outside Conditions on load.
    //getExtConditions();
    setInterval(function(){getShedConditions();}, 60000 )
});

$(window).on("resize", function(){resizeHeader();});

function resizeHeader(){
    var titleHeight = $('#title').height();
    $('#iconsLeft,#iconsRight').height(titleHeight).find('span').css('line-height', titleHeight.toString() + 'px');
}

$('#btnRefreshShed').on('click', function(){getShedConditions()});
$('#showExtConditions').on('click', function(){
    if($('#outside').hasClass('hidden')){
        getExtConditions();
        $(this).text('Hide Outside Conditions');        
    } else {
        $('#outside').addClass('hidden')
        $('#wuLogo').addClass('hidden');
        $(this).text('Show Outside Conditions');
        
    }

})
$('#btnRefreshExt').on('click', function(){getExtConditions()});

 $.ajax({
        method: 'GET',
        url: '/notifications',
        dataType: 'JSON',
        success: function(data){
            if(data == undefined){
                return;
            }   
            var isActive = false;
            var isInactive = false;
            var activeContainer = $('<div/>').attr('id', 'activeAlerts');
            var inactiveContainer = $('<div/>').attr('id', 'inactiveAlerts');
            for(i = 0; i < data.length; i++){
                var prefix = "";
                var $alertContainer = null;
                if(data[i].isActive) {
                    isActive = true;
                    $alertContainer = activeContainer;
                    prefix = 'active';
                }else{
                    isInactive = true;
                    $alertContainer = inactiveContainer;
                    prefix = 'inactive';
                }

                var logic = '';
                if(data[i].isGreaterThan){
                    logic += 'greater than';
                }else if(data[i].isLessThan){
                    logic += 'less than';
                }

                if(data[i].isEqualTo)
                {
                    if(logic.length > 0)
                        logic += ' ';
                    logic += 'equal to'
                }

                var $remove = $('<span/>').addClass('glyphicon').addClass('glyphicon-remove').data('notificationId', i.toString()).css('cursor', 'hand').css('color', 'red');
                $remove.on('click', function(){
                    console.log('Delete ' + $(this).data('notificationId'));
                });

                var $alertDiv = $('<div/>').html("&nbsp;Send alert when temperature is ");
                $alertDiv.prepend($remove);

                //Add Remove Button
                $alertDiv.append($('<span/>').attr('id', 'activeCompare' + i.toString()).html('<strong>' + logic + "</strong>&nbsp;"));
                $alertDiv.append($('<span/>').attr('id', 'activeValue' + i.toString()).html('<strong>' + data[i].compareValue + '°F</strong>'));
                $alertContainer.append($alertDiv);
                //Add Create Button
            }
            if(isActive){
                $('#activePanelBody').append(activeContainer)
                $('#activePanel').removeClass('hidden');
            }else{
                $('#activePanelBody').addClass('hidden');
            }


            if(false && isInactive){
                $('#inactivePanelBody').append(inactiveContainer)
                    $('#inactivePanel').removeClass('hidden');
            }else{
                $('#inactivePanelBody').addClass('hidden');
            }            
        }
 });

  $.ajax({
        method: 'GET',
        url: '/users',
        dataType: 'JSON',
        success: function(data){
            if(data == undefined){
                return;
            }   
            for(i = 0; i < data.length; i++){
                if(!data[i].sendAlerts | !data[i].isActive){
                    continue;
                }

                var $li = $('<li/>').html(data[i].name);
                $li.append($('<ul />'));
                console.log($li.children('ul'));
                if(data[i].eMail.length > 0){
                    $li.children('ul').append($('<li/>').html(data[i].eMail));
                }

                if(data[i].smsAddress.length > 0){
                    $li.children('ul').append($('<li/>').html(data[i].cellPhone + '@' + data[i].smsAddress));
                }
                $('#liUsers').append($li);

            }
        }
  });
</script>